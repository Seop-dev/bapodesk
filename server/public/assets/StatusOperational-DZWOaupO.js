import{aZ as fe,a_ as ce,O as r,a8 as me,P as pe,q as Y,o as g,a as o,w as s,c as x,k as _e,V as T,b as y,f as R,e as c,a0 as m,A as $,a1 as Se,d as we,aY as C,a3 as E,a4 as _,F as I,s as ge,W as ye,$ as i}from"./index-BkOgXO0r.js";import{_ as Ae,a as Te}from"./UiParentCard.vue_vue_type_script_setup_true_lang-BW8k9qJX.js";import{_ as Re}from"./NewModal-C5NqQFOW.js";import{B as Ce}from"./main-CfRLyuEJ.js";const Ee={class:"text-right mt-2"},f="http://localhost:3000",ve={__name:"StatusOperational",setup(De){fe.registerModules([ce]);const k=Se,O=`${f}/process`;let S=new Map,D=new Map;const F=r([]),U=async()=>{const[t,e]=await Promise.all([i.get(`${f}/common/codes/FC`),i.get(`${f}/common/codes/RR`)]),l=n=>{const u=new Map;for(const d of n||[])u.set(String(d.code??d.CODE),d.code_name??d.CODE_NAME);return u};S=l(t.data),D=l(e.data),F.value=Array.isArray(e.data)?e.data:[]},p=r(""),w=r(null),B=async t=>{w.value=t.api,await A()},b=t=>{w.value&&(w.value.setFilterModel({공정코드:{filterType:"text",type:"equals",filter:t||""}}),w.value.onFilterChanged())},W={editable:!1,sortable:!0,resizable:!0,suppressHeaderMenuButton:!0},G=t=>t==="가동"?{color:"blue",fontWeight:"bold"}:t==="비가동"?{color:"red",fontWeight:"bold"}:null,z=r([{field:"공정코드",hide:!0,filter:"agTextColumnFilter"},{field:"설비코드",flex:1},{field:"설비명",flex:1},{field:"설비유형",flex:1},{field:"설비상태",flex:1,cellStyle:t=>G(t.value)},{field:"비가동사유",flex:1},{field:"고장유형",flex:1},{field:"비가동시작시간",flex:1}]),V=r([]),H=async()=>{const{data:t}=await i.get(`${f}/facility`);return t||[]},q=async()=>{try{const{data:t}=await i.get(`${f}/facility/status`);return t||[]}catch{return[]}},L=t=>{if(!t)return"";const e=new Date(t),l=n=>String(n).padStart(2,"0");return`${e.getFullYear()}-${l(e.getMonth()+1)}-${l(e.getDate())} ${l(e.getHours())}:${l(e.getMinutes())}:${l(e.getSeconds())}`},h=t=>({0:"가동",1:"비가동",2:"점검중"})[Number(t)]??String(t),K=(t,e)=>{const l=new Map(e.map(n=>[n.FAC_ID,n]));return(t||[]).map(n=>{const u=l.get(n.FAC_ID)||{},d=Number(n.FS_STATUS??0),se=h(d),de=d===1&&n.FS_REASON||"-",re=d===1&&n.FS_TYPE?D.get(String(n.FS_TYPE))||n.FS_TYPE:"-",ue=d===1&&n.DOWN_STARTDAY?L(n.DOWN_STARTDAY):"-",ie=u.FAC_TYPE?S.get(String(u.FAC_TYPE))||u.FAC_TYPE:u.FAC_TYPE_NM||"-";return{공정코드:u.PR_ID||"",설비코드:n.FAC_ID,설비명:n.FAC_NAME||u.FAC_NAME||"",설비유형:ie,설비상태:se,비가동사유:de,고장유형:re,비가동시작시간:ue,_fsId:n.FS_ID||null,_fsStatus:d,_downEnd:n.DOWN_ENDDAY||null,_fsType:n.FS_TYPE||null}})},X=t=>(t||[]).map(e=>({공정코드:e.PR_ID||"",설비코드:e.FAC_ID,설비명:e.FAC_NAME||"",설비유형:e.FAC_TYPE?S.get(String(e.FAC_TYPE))||e.FAC_TYPE:"-",설비상태:"가동",비가동사유:"-",고장유형:"-",비가동시작시간:"-",담당자:e.MANAGER||"-",_fsId:null,_fsStatus:0,_downEnd:null,_fsType:null})),A=async()=>{await U();const[t,e]=await Promise.all([H(),q()]);V.value=e.length>0?K(e,t):X(t),p.value&&b(p.value)},a=me({code:"",name:"",type:"",targetStatus:"비가동",downReason:"",errType:"",downStart:"",downEnd:"",manager:"-",_fsId:null,_downEnd:null,_fsStatus:0,_fsType:null}),Q=t=>{const e=t.data,l=e.설비상태==="가동";a.code=e.설비코드,a.name=e.설비명,a.type=e.설비유형,a.targetStatus=l?"비가동":"가동",a.downReason=l?"":e.비가동사유!=="-"?e.비가동사유:"",a.errType=l?"":t.data._fsType||"",a.downStart=l?"":e.비가동시작시간!=="-"?e.비가동시작시간:"",a.downEnd="",a._fsId=t.data._fsId||null,a._fsStatus=t.data._fsStatus||0},Z=async()=>{if(a.targetStatus!=="비가동"||!a.code)return;if(!a.downReason)return alert("비가동 사유를 선택하세요.");if(a.downReason==="고장"&&!a.errType)return alert("고장 유형을 선택하세요.");if(!confirm("비가동으로 변경할까요?"))return;const t=P();try{a._fsId?await i.patch(`${f}/facility/status/down`,{FS_ID:a._fsId,FS_STATUS:1,FS_REASON:a.downReason,FS_TYPE:a.downReason==="고장"?a.errType:null,DOWN_STARTDAY:t,FS_CHECKDAY:t,FS_NEXTDAY:null,MANAGER:a.manager||"-"}):await i.post(`${f}/facility/status`,{FAC_ID:a.code,FS_STATUS:1,FS_REASON:a.downReason,FS_TYPE:a.downReason==="고장"?a.errType:null,DOWN_STARTDAY:t,FS_CHECKDAY:t,FS_NEXTDAY:null,MANAGER:a.manager||"-"}),a.downStart=t,a.downEnd="",await A(),alert("비가동 처리되었습니다.")}catch(e){console.error(e),alert("비가동 처리 중 오류가 발생했습니다.")}},j=async()=>{if(a.targetStatus!=="가동"||!a.code)return;const t=a._fsId,e=P();try{t&&await i.patch(`${f}/facility/status/end`,{FS_ID:t,endTime:e,restoreStatus:0,checkTime:e}),a.downEnd=e,await A(),a.downReason="",a.errType="",a.downStart="",alert("가동으로 전환되었습니다.")}catch(l){console.error(l),alert("가동 처리 중 오류가 발생했습니다.")}};function P(){const t=new Date,e=l=>String(l).padStart(2,"0");return`${t.getFullYear()}-${e(t.getMonth()+1)}-${e(t.getDate())} ${e(t.getHours())}:${e(t.getMinutes())}:${e(t.getSeconds())}`}const v=r(null),N=r(""),M=r([]),J=r([{field:"공정코드",flex:1},{field:"공정명",flex:1},{field:"설비유형",flex:1},{field:"등록일자",flex:1},{field:"작성자",flex:1},{field:"비고",flex:1}]),ee=t=>({공정코드:t.PR_ID??t.PRC_CODE??"",공정명:t.PRC_NAME??"",설비유형:t.FAC_TYPE?S.get(String(t.FAC_TYPE))||t.FAC_TYPE:"-",등록일자:(typeof t.PRC_RDATE=="string"?t.PRC_RDATE.slice(0,10):"")||"",작성자:t.PRC_WRITER??"",비고:t.PRC_NOTE??""}),te=async()=>{const{data:t}=await i.get(O);return(Array.isArray(t)?t:[]).map(ee)},ae=async t=>{var e;try{N.value=t,M.value=await te(),(e=v.value)==null||e.open()}catch(l){console.error("[process list] error:",l),alert("공정 목록 조회 실패")}},le=t=>{t&&(p.value=t.공정코드||"",b(t.공정코드))},oe=r({title:"설비 상태 관리"}),ne=pe([{title:"설비",disabled:!0,href:"#"},{title:"비가동 관리",disabled:!1,href:"#"}]);return(t,e)=>(g(),Y(I,null,[o(Ae,{title:oe.value.title,breadcrumbs:ne.value},null,8,["title","breadcrumbs"]),o(Te,{title:"비가동 관리"},{default:s(()=>[o(T,{class:"mb-2 py-0"},{default:s(()=>[o(y,{cols:"12",class:"d-flex align-center"},{default:s(()=>[o(R,{color:"warning",variant:"flat",onClick:e[0]||(e[0]=l=>ae("공정 조회"))},{default:s(()=>e[10]||(e[10]=[c(" 공정 조회 ")])),_:1})]),_:1})]),_:1}),o(T,{class:"mb-4 pt-0"},{default:s(()=>[o(y,{cols:"12",md:"3"},{default:s(()=>[o(m,{label:"공정코드",modelValue:p.value,"onUpdate:modelValue":e[1]||(e[1]=l=>p.value=l),readonly:"","hide-details":"",density:"comfortable",variant:"outlined"},null,8,["modelValue"])]),_:1})]),_:1}),o($(Ce),{class:"ag-theme-quartz grid-clean",style:{height:"260px"},theme:$(k),rowData:V.value,columnDefs:z.value,defaultColDef:W,animateRows:!0,suppressClickEdit:!0,pagination:!0,"pagination-page-size":10,onGridReady:B,onRowClicked:Q},null,8,["theme","rowData","columnDefs"]),a.code?(g(),x(ye,{key:0,class:"mt-6 pa-4"},{default:s(()=>[o(T,{dense:""},{default:s(()=>[o(y,{cols:"12",md:"6"},{default:s(()=>[o(m,{label:"설비코드",modelValue:a.code,"onUpdate:modelValue":e[2]||(e[2]=l=>a.code=l),dense:"",outlined:"",readonly:""},null,8,["modelValue"]),o(m,{label:"설비명",modelValue:a.name,"onUpdate:modelValue":e[3]||(e[3]=l=>a.name=l),dense:"",outlined:"",readonly:""},null,8,["modelValue"]),o(m,{label:"설비유형",modelValue:a.type,"onUpdate:modelValue":e[4]||(e[4]=l=>a.type=l),dense:"",outlined:"",readonly:""},null,8,["modelValue"]),o(m,{label:"비가동 시작일시",modelValue:a.downStart,"onUpdate:modelValue":e[5]||(e[5]=l=>a.downStart=l),dense:"",outlined:"",readonly:""},null,8,["modelValue"]),o(m,{class:"mt-2",label:"비가동 완료일시",modelValue:a.downEnd,"onUpdate:modelValue":e[6]||(e[6]=l=>a.downEnd=l),dense:"",outlined:"",readonly:""},null,8,["modelValue"])]),_:1}),o(y,{cols:"12",md:"6"},{default:s(()=>[o(C,{class:"mb-1 d-block"},{default:s(()=>e[11]||(e[11]=[c("상태 선택")])),_:1}),o(E,{modelValue:a.targetStatus,"onUpdate:modelValue":e[7]||(e[7]=l=>a.targetStatus=l),inline:""},{default:s(()=>[o(_,{label:"가동",value:"가동"}),o(_,{label:"비가동",value:"비가동"})]),_:1},8,["modelValue"]),o(C,{class:"mb-1 d-block"},{default:s(()=>e[12]||(e[12]=[c("비가동 사유")])),_:1}),o(E,{modelValue:a.downReason,"onUpdate:modelValue":e[8]||(e[8]=l=>a.downReason=l),inline:"",disabled:a.targetStatus!=="비가동"},{default:s(()=>[o(_,{label:"고장",value:"고장"}),o(_,{label:"점검",value:"점검"})]),_:1},8,["modelValue","disabled"]),o(C,{class:"mb-1 d-block"},{default:s(()=>e[13]||(e[13]=[c("고장 유형")])),_:1}),o(E,{modelValue:a.errType,"onUpdate:modelValue":e[9]||(e[9]=l=>a.errType=l),inline:"",disabled:a.targetStatus!=="비가동"||a.downReason!=="고장"},{default:s(()=>[(g(!0),Y(I,null,ge(F.value,l=>(g(),x(_,{key:l.code,label:l.code_name,value:l.code},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"]),we("div",Ee,[o(R,{color:"error",disabled:a.targetStatus!=="비가동",onClick:Z},{default:s(()=>e[14]||(e[14]=[c("비가동")])),_:1},8,["disabled"]),o(R,{class:"ml-2",color:"primary",disabled:a.targetStatus!=="가동",onClick:j},{default:s(()=>e[15]||(e[15]=[c("가동")])),_:1},8,["disabled"])])]),_:1})]),_:1})]),_:1})):_e("",!0)]),_:1}),o(Re,{ref_key:"modalRef",ref:v,title:N.value,rowData:M.value,colDefs:J.value,onConfirm:le},null,8,["title","rowData","colDefs"])],64))}};export{ve as default};
