import{aZ as ee,a_ as le,O as i,P as te,a8 as ae,_ as oe,q as ne,o as T,a,w as s,c as se,k as de,V,b as p,f as P,e as g,a0 as d,A as M,a1 as ie,d as y,aY as re,a3 as ue,a4 as N,W as fe,F as me,$ as c}from"./index-BkOgXO0r.js";import{d as D}from"./dayjs.min-DF61od3U.js";import{_ as ce,a as pe}from"./UiParentCard.vue_vue_type_script_setup_true_lang-BW8k9qJX.js";import{_ as Ae}from"./NewModal-C5NqQFOW.js";import{B as _e}from"./main-CfRLyuEJ.js";const Ce={class:"mt-2"},Ve={class:"text-right mt-6"},ve={__name:"CheckManagement",setup(ge){var F,S;ee.registerModules([le]);const Y=ie,I=i({title:"설비 점검관리"}),k=te([{title:"설비",disabled:!0,href:"#"},{title:"점검 관리",disabled:!1,href:"#"}]),u=((S=(F=import.meta)==null?void 0:F.env)==null?void 0:S.VITE_API_BASE)||"/api",O=`${u}/facility/inspection/complete`,U=`${u}/process`;let A=new Map;const $=async()=>{const{data:l}=await c.get(`${u}/common/codes/FC`);A=new Map(l.map(e=>[String(e.code??e.CODE),e.code_name??e.CODE_NAME]))},f=i(""),m=i(null),B=l=>{m.value=l.api,C()},b=l=>{m.value&&(m.value.setFilterModel({공정코드:{filterType:"text",type:"equals",filter:l||""}}),m.value.onFilterChanged())},H=i([{field:"공정코드",hide:!0,filter:"agTextColumnFilter"},{field:"설비코드",flex:1},{field:"설비명",flex:1},{field:"설비유형",flex:1},{field:"설비상태",flex:1,cellStyle:l=>l.value==="점검"?{color:"red",fontWeight:"bold"}:{color:"blue",fontWeight:"bold"}},{field:"비가동사유",flex:1},{field:"비가동시작시간",flex:1},{field:"적합여부",flex:1,hide:!0},{field:"다음점검일",flex:1,hide:!0},{field:"담당자",flex:1}]),W={editable:!1,sortable:!0,resizable:!0},G=async()=>(await c.get(`${u}/facility`)).data||[],L=async()=>(await c.get(`${u}/facility/status`)).data||[],_=i([]),R=l=>l?D(l).format("YYYY-MM-DD HH:mm:ss"):"-",z=(l,e)=>{const o=new Map(e.map(n=>[n.FAC_ID,n]));return l.filter(n=>Number(n.FS_STATUS)===1&&(n.FS_REASON||"")==="점검").map(n=>{const r=o.get(n.FAC_ID)||{},h=r.FAC_TYPE?A.get(String(r.FAC_TYPE))||r.FAC_TYPE:r.FAC_TYPE_NM||"-";return{공정코드:r.PR_ID||"",설비코드:n.FAC_ID,설비명:r.FAC_NAME||"",설비유형:h,설비상태:"점검",비가동사유:n.FS_REASON||"점검",비가동시작시간:n.DOWN_STARTDAY?R(n.DOWN_STARTDAY):n.FS_CHECKDAY?R(n.FS_CHECKDAY):"",적합여부:"-",다음점검일:n.FS_NEXTDAY?String(n.FS_NEXTDAY).slice(0,10):"-",담당자:n.MANAGER??r.MANAGER??"-",_fsId:n.FS_ID}})},C=async()=>{try{await $();const[l,e]=await Promise.all([G(),L()]);_.value=z(e,l),f.value&&b(f.value)}catch(l){console.error(l),_.value=[]}},t=ae({code:"",name:"",type:"",manager:"",downStart:"",doneAt:"",nextAt:"",inspectNote:"",fit:"",ngReason:"",_fsId:null}),j=l=>{const e=l.data;Object.assign(t,{code:e.설비코드,name:e.설비명,type:e.설비유형,manager:e.담당자==="-"?"":e.담당자,downStart:e.비가동시작시간||x(),doneAt:"",nextAt:e.다음점검일==="-"?"":e.다음점검일,inspectNote:"",fit:"",ngReason:"",_fsId:e._fsId})},q=async()=>{var l;if(!t._fsId)return alert("설비를 먼저 선택하세요.");if(!t.fit)return alert("적합 여부를 선택하세요.");if(t.fit==="부적합"&&!t.ngReason.trim())return alert("부적합 사유를 입력하세요.");t.doneAt=x();try{await c.post(O,{FS_ID:t._fsId,FAC_ID:t.code,fit:t.fit,ngReason:t.fit==="부적합"?t.ngReason:null,content:t.inspectNote||null,nextAt:t.nextAt||null,doneAt:t.doneAt,manager:t.manager||null}),await C(),(l=m.value)==null||l.refreshCells({force:!0}),alert("점검이 완료되었습니다."),Object.assign(t,{code:"",name:"",type:"",manager:"",downStart:"",doneAt:"",nextAt:"",inspectNote:"",fit:"",ngReason:"",_fsId:null})}catch(e){console.error("[inspection complete] error:",e),alert("점검 완료 처리 중 오류가 발생했습니다.")}};function x(){return D().format("YYYY-MM-DD HH:mm:ss")}const E=i(null),v=i(""),w=i([]),K=i([{field:"공정코드",flex:1},{field:"공정명",flex:1},{field:"설비유형",flex:1},{field:"등록일자",flex:1},{field:"작성자",flex:1},{field:"비고",flex:1}]),X=l=>({공정코드:l.PR_ID??l.PRC_CODE??"",공정명:l.PRC_NAME??"",설비유형:l.FAC_TYPE?A.get(String(l.FAC_TYPE))||l.FAC_TYPE:"-",등록일자:l.PRC_RDATE?D(l.PRC_RDATE).format("YYYY-MM-DD"):"",작성자:l.PRC_WRITER??"",비고:l.PRC_NOTE??""}),Q=async()=>{const{data:l}=await c.get(U);return(Array.isArray(l)?l:[]).map(X)},Z=async l=>{var e;try{v.value=l,w.value=await Q(),(e=E.value)==null||e.open()}catch(o){console.error("[process list] error:",o),alert("공정 목록 조회 실패")}},J=l=>{l&&(f.value=l.공정코드||"",b(l.공정코드))};return oe(C),(l,e)=>(T(),ne(me,null,[a(ce,{title:I.value.title,breadcrumbs:k.value},null,8,["title","breadcrumbs"]),a(pe,{title:"설비 점검관리"},{default:s(()=>[a(V,{class:"mb-2 py-0"},{default:s(()=>[a(p,{cols:"12",class:"d-flex align-center"},{default:s(()=>[a(P,{color:"warning",variant:"flat",onClick:e[0]||(e[0]=o=>Z("공정 조회"))},{default:s(()=>e[12]||(e[12]=[g("공정 조회")])),_:1})]),_:1})]),_:1}),a(V,{class:"mb-4 pt-0"},{default:s(()=>[a(p,{cols:"12",md:"3"},{default:s(()=>[a(d,{label:"공정코드",modelValue:f.value,"onUpdate:modelValue":e[1]||(e[1]=o=>f.value=o),readonly:"","hide-details":"",density:"comfortable",variant:"outlined"},null,8,["modelValue"])]),_:1})]),_:1}),a(M(_e),{style:{height:"260px"},theme:M(Y),rowData:_.value,columnDefs:H.value,defaultColDef:W,animateRows:!0,suppressClickEdit:!0,pagination:!0,"pagination-page-size":10,onGridReady:B,onRowClicked:j},null,8,["theme","rowData","columnDefs"]),a(Ae,{ref_key:"modalRef",ref:E,title:v.value,rowData:w.value,colDefs:K.value,onConfirm:J},null,8,["title","rowData","colDefs"]),t.code?(T(),se(fe,{key:0,class:"mt-6 pa-4 rounded-xl elevation-1 checker-card"},{default:s(()=>[e[15]||(e[15]=y("h3",null,"점검 처리 입력",-1)),a(V,{dense:""},{default:s(()=>[a(p,{cols:"12",md:"6"},{default:s(()=>[a(d,{label:"설비코드",modelValue:t.code,"onUpdate:modelValue":e[2]||(e[2]=o=>t.code=o),dense:"",outlined:"",readonly:""},null,8,["modelValue"]),a(d,{label:"설비명",modelValue:t.name,"onUpdate:modelValue":e[3]||(e[3]=o=>t.name=o),dense:"",outlined:"",readonly:""},null,8,["modelValue"]),a(d,{label:"설비유형",modelValue:t.type,"onUpdate:modelValue":e[4]||(e[4]=o=>t.type=o),dense:"",outlined:"",readonly:""},null,8,["modelValue"]),a(d,{label:"점검내역",modelValue:t.inspectNote,"onUpdate:modelValue":e[5]||(e[5]=o=>t.inspectNote=o),dense:"",outlined:""},null,8,["modelValue"]),a(d,{label:"담당자",modelValue:t.manager,"onUpdate:modelValue":e[6]||(e[6]=o=>t.manager=o),dense:"",outlined:""},null,8,["modelValue"]),a(d,{label:"부적합 사유",modelValue:t.ngReason,"onUpdate:modelValue":e[7]||(e[7]=o=>t.ngReason=o),dense:"",outlined:"",disabled:t.fit!=="부적합"},null,8,["modelValue","disabled"])]),_:1}),a(p,{cols:"12",md:"6"},{default:s(()=>[a(d,{label:"비가동 시작일",modelValue:t.downStart,"onUpdate:modelValue":e[8]||(e[8]=o=>t.downStart=o),dense:"",outlined:"",readonly:""},null,8,["modelValue"]),a(d,{label:"점검 완료일",modelValue:t.doneAt,"onUpdate:modelValue":e[9]||(e[9]=o=>t.doneAt=o),dense:"",outlined:"",readonly:""},null,8,["modelValue"]),a(d,{label:"다음 점검일",modelValue:t.nextAt,"onUpdate:modelValue":e[10]||(e[10]=o=>t.nextAt=o),type:"date",dense:"",outlined:""},null,8,["modelValue"]),y("div",Ce,[a(re,{class:"mb-2 d-block"},{default:s(()=>e[13]||(e[13]=[g("적합 여부")])),_:1}),a(ue,{modelValue:t.fit,"onUpdate:modelValue":e[11]||(e[11]=o=>t.fit=o),inline:"",density:"compact"},{default:s(()=>[a(N,{label:"적합",value:"적합"}),a(N,{label:"부적합",value:"부적합"})]),_:1},8,["modelValue"])]),y("div",Ve,[a(P,{color:"primary",onClick:q},{default:s(()=>e[14]||(e[14]=[g("점검완료")])),_:1})])]),_:1})]),_:1})]),_:1})):de("",!0)]),_:1})],64))}};export{ve as default};
