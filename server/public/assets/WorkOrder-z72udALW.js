import{O as u,P as Qe,a8 as ze,_ as Fe,$ as b,y,a7 as Ge,q,o as A,a as l,w as r,d,f as w,e as f,V as Te,b as p,a0 as c,aM as Me,aN as X,A as z,W as ee,S as te,T as ae,Z as oe,Y as le,aP as $e,F as de,s as Be,t as h,aO as Ue}from"./index-BkOgXO0r.js";import{_ as _e,a as qe}from"./UiParentCard.vue_vue_type_script_setup_true_lang-BW8k9qJX.js";import{B as F}from"./main-CfRLyuEJ.js";import{_ as Ae}from"./_plugin-vue_export-helper-DlAUqK2U.js";const Ie={class:"card-headline"},Le={class:"center-actions-under-form"},Oe={class:"main-2col"},Ee={class:"pane"},He={class:"pane-head"},Ke={class:"pane-action"},je={class:"pane right-pane"},Ze={class:"r"},Ye={class:"r"},Je={class:"r text-red"},D="http://localhost:3000",Xe=10,re=3,et=10,tt={__name:"WorkOrder",setup(at){const ne=u({title:"작업지시 관리"}),se=Qe([{title:"생산",disabled:!0,href:"#"},{title:"작업지시 관리",disabled:!1,href:"#"}]),N=u({open:!1,msg:"",color:"primary"}),m=(t,e="primary")=>N.value={open:!0,msg:t,color:e},S=u(!1),I=u([]),o=ze({issueNumber:"",orderDate:"",contact:"",productCode:"",productName:"",dueDate:"",targetQty:10,orderName:"",memo:""});function G(){const t=new Date,e=t.getFullYear(),a=String(t.getMonth()+1).padStart(2,"0"),i=String(t.getDate()).padStart(2,"0"),s=Math.floor(Math.random()*9e3+1e3);return`WO-${e}${a}${i}-${s}`}Fe(()=>{o.issueNumber||(o.issueNumber=G()),o.orderDate||(o.orderDate=new Date().toISOString().slice(0,10)),L()});const T=u([]),x=u("");async function L(){try{const{data:t}=await b.get(`${D}/products`,{params:{kw:x.value,page:1,size:100}});(t!=null&&t.ok||t!=null&&t.rows)&&(T.value=t.rows||[])}catch(t){console.error(t),m("제품 조회 오류","error")}}const ie=y(()=>{const t=x.value.trim().toLowerCase();return t?T.value.filter(e=>e.code.toLowerCase().includes(t)||e.name.toLowerCase().includes(t)):T.value}),ue=y(()=>ie.value);function me(){L()}const P=u([]),ce=y(()=>P.value);async function W(t,e){P.value=[];const a=String(t||"").trim(),i=Math.max(Number(e||0),0);if(a)try{const{data:s}=await b.get(`${D}/materials/status`,{params:{productCode:a,targetQty:i}}),Re=(s==null?void 0:s.rows)||[];P.value=Re.map(J=>({...J,status:Number(J.shortage||0)>0?"부족":"가능"}))}catch(s){console.error(s),m("자재현황 조회 오류","error")}}const M=u(null),k=u([]),pe=y(()=>k.value);async function O(t){if(M.value=null,k.value=[],!!t)try{const{data:e}=await b.get(`${D}/boms`,{params:{productCode:t}});(e!=null&&e.ok||e!=null&&e.items)&&(M.value=e.header||null,k.value=(e.items||[]).map(a=>({seq:a.seq,matCode:a.matCode,matName:a.matName,matType:a.matType,qty:a.qty,unit:a.unit})))}catch(e){console.error(e),m("BOM 조회 오류","error")}}const C=u(!1),V=u(""),R=u([]);async function E(){try{const t=V.value.trim(),{data:e}=await b.get(`${D}/plans`,{params:{kw:t,page:1,size:200}});e!=null&&e.ok||e!=null&&e.rows?R.value=e.rows||[]:m("계획서 조회 실패","error")}catch(t){console.error(t),m("계획서 조회 오류","error")}}function fe(){E()}function ge(){V.value="",C.value=!0,E()}const he=y(()=>{const t=V.value.trim().toLowerCase();return t?R.value.filter(e=>e.planNo.toLowerCase().includes(t)||e.productCode.toLowerCase().includes(t)||e.productName.toLowerCase().includes(t)):R.value}),ve=y(()=>he.value),v=u([]);function ye(t){const e=t.api.getSelectedRows();if(e.length===0){v.value=[];return}const a=e[0];e.filter(s=>s.productCode!==a.productCode||s.productType!==a.productType).length&&(t.api.forEachNode(s=>{s.isSelected()&&(s.data.productCode!==a.productCode||s.data.productType!==a.productType)&&s.setSelected(!1)}),m("같은 제품/유형만 복수 선택 가능합니다.","error")),v.value=t.api.getSelectedRows().map(s=>s.id)}function we(){if(!v.value.length){m("계획서를 선택하세요.","error");return}const t=R.value.filter(i=>v.value.includes(i.id)),e=t[0];o.productCode=e.productCode,o.productName=e.productName,o.dueDate=t.map(i=>i.dueDate).sort()[0],o.targetQty=t.reduce((i,s)=>i+Number(s.totalQty||0),0);const a=t.map(i=>i.planName).filter(Boolean);o.orderName=a.join(", ").slice(0,200),C.value=!1,O(o.productCode),W(o.productCode,o.targetQty)}function Ne(t){var a,i;const e=(((i=(a=t.api).getSelectedRows)==null?void 0:i.call(a))??[])[0];e!=null&&e.code&&(o.productCode=e.code,o.productName=e.name,O(o.productCode),W(o.productCode,o.targetQty))}Ge([()=>o.productCode,()=>o.targetQty],([t,e])=>{t&&W(t,e)});async function Ce(){var t;if(o.issueNumber||(o.issueNumber=G()),!o.orderDate||!o.productCode||!o.productName||!o.dueDate||!((t=o.contact)!=null&&t.trim())){m("필수 항목이 비어있습니다. (지시일자, 제품, 납기일자, 작성자)","error");return}if(!o.targetQty||o.targetQty<=0){m("목표수량을 1 이상으로 입력하세요.","error");return}try{const e={form:{issueNumber:o.issueNumber,orderDate:o.orderDate,writer:o.contact,contact:o.contact,productCode:o.productCode,productName:o.productName,dueDate:o.dueDate,targetQty:Number(o.targetQty||0),orderName:o.orderName||null,memo:o.memo||""},selectedPlanIds:v.value},{data:a}=await b.post(`${D}/workorders`,e);a!=null&&a.ok?(m(`작업지시 저장 완료 (ID: ${a.woId}, NO: ${a.woNo})`,"success"),H(),W(o.productCode,o.targetQty)):(Array.isArray(a==null?void 0:a.shortages)&&a.shortages.length&&(I.value=a.shortages,S.value=!0),m((a==null?void 0:a.msg)||"저장 실패","error"))}catch(e){console.error(e),m("저장 중 오류","error")}}function H(){o.issueNumber=G(),o.orderDate=new Date().toISOString().slice(0,10),o.contact="",o.productCode="",o.productName="",o.dueDate="",o.targetQty=10,o.orderName="",o.memo="",v.value=[],M.value=null,k.value=[],P.value=[]}const n={cellStyle:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},tooltipValueGetter:t=>t.value},g={...n,cellClass:"ag-right-aligned-cell",valueFormatter:t=>t.value==null?"":String(t.value)},Ve=[{headerName:"제품코드",field:"code",flex:1.2,minWidth:120,...n},{headerName:"제품명",field:"name",flex:1.8,minWidth:160,...n},{headerName:"유형",field:"type",flex:.8,minWidth:90,...n},{headerName:"단위",field:"uom",flex:.6,minWidth:70,...n},{headerName:"규격",field:"spec",flex:1.2,minWidth:120,...n}],be=[{headerName:"자재코드",field:"matCode",flex:1.1,minWidth:110,...n},{headerName:"자재명",field:"matName",flex:1.4,minWidth:120,...n},{headerName:"단위",field:"unit",flex:.6,minWidth:70,...n},{headerName:"BOM(단위당)",field:"bomQty",flex:.8,minWidth:110,...g},{headerName:"필요수량",field:"requiredQty",flex:.8,minWidth:100,...g},{headerName:"가용재고",field:"availableQty",flex:.8,minWidth:100,...g},{headerName:"부족수량",field:"shortage",flex:.8,minWidth:100,...g,cellClassRules:{"ag-cell--danger":t=>Number(t.value||0)>0}},{headerName:"상태",field:"status",width:90,valueFormatter:t=>t.value==="부족"?"부족":"가능",cellClassRules:{"ag-cell--danger":t=>t.value==="부족","ag-cell--ok":t=>t.value!=="부족"}}],De=[{headerName:"자재코드",field:"matCode",flex:1.1,minWidth:110,...n},{headerName:"자재명",field:"matName",flex:1.2,minWidth:110,...n},{headerName:"자재유형",field:"matType",flex:.9,minWidth:90,...n},{headerName:"소요수량",field:"qty",flex:.8,minWidth:90,...g},{headerName:"단위",field:"unit",flex:.7,minWidth:80,...n}],Se=[{headerName:"",checkboxSelection:!0,headerCheckboxSelection:!0,width:70},{headerName:"순번",valueGetter:"node.rowIndex + 1",width:80,...g},{headerName:"계획번호",field:"planNo",minWidth:140,flex:1,...n},{headerName:"계획명",field:"planName",minWidth:140,flex:1,...n},{headerName:"주문코드",field:"orderNo",minWidth:120,...n},{headerName:"제품코드",field:"productCode",minWidth:120,...n},{headerName:"제품명",field:"productName",minWidth:140,flex:1,...n},{headerName:"유형",field:"productType",width:100,...n},{headerName:"작성일자",field:"createdDate",minWidth:120,...n},{headerName:"작성자",field:"writer",width:100,...n},{headerName:"총수량",field:"totalQty",width:110,...g},{headerName:"납기일자",field:"dueDate",minWidth:120,...n}];let K,j,Z,Y;function Q(t){t&&t.sizeColumnsToFit()}function xe(t){K=t.api,$()}function Pe(t){j=t.api,B()}function We(t){Z=t.api,U()}function ke(t){Y=t.api,_()}function $(){Q(K)}function B(){Q(j)}function U(){Q(Z)}function _(){Q(Y)}return(t,e)=>(A(),q(de,null,[l(_e,{title:ne.value.title,breadcrumbs:se.value},null,8,["title","breadcrumbs"]),l(qe,null,{default:r(()=>[d("div",Ie,[e[17]||(e[17]=d("h5",{class:"title"},"작업지시 등록",-1)),l(w,{color:"warning",onClick:ge},{default:r(()=>e[16]||(e[16]=[f("계획서 조회")])),_:1})]),l(Te,{class:"mb-2"},{default:r(()=>[l(p,{cols:"4"},{default:r(()=>[l(c,{label:"지시번호",modelValue:o.issueNumber,"onUpdate:modelValue":e[0]||(e[0]=a=>o.issueNumber=a),readonly:"",dense:"",outlined:""},null,8,["modelValue"])]),_:1}),l(p,{cols:"4"},{default:r(()=>[l(c,{label:"지시일자",modelValue:o.orderDate,"onUpdate:modelValue":e[1]||(e[1]=a=>o.orderDate=a),type:"date",dense:"",outlined:""},null,8,["modelValue"])]),_:1}),l(p,{cols:"4"},{default:r(()=>[l(c,{label:"작성자",modelValue:o.contact,"onUpdate:modelValue":e[2]||(e[2]=a=>o.contact=a),dense:"",outlined:""},null,8,["modelValue"])]),_:1}),l(p,{cols:"4"},{default:r(()=>[l(c,{label:"제품코드",modelValue:o.productCode,"onUpdate:modelValue":e[3]||(e[3]=a=>o.productCode=a),readonly:"",dense:"",outlined:""},null,8,["modelValue"])]),_:1}),l(p,{cols:"4"},{default:r(()=>[l(c,{label:"납기일자",modelValue:o.dueDate,"onUpdate:modelValue":e[4]||(e[4]=a=>o.dueDate=a),type:"date",dense:"",outlined:""},null,8,["modelValue"])]),_:1}),l(p,{cols:"4"},{default:r(()=>[l(c,{label:"목표수량",modelValue:o.targetQty,"onUpdate:modelValue":e[5]||(e[5]=a=>o.targetQty=a),modelModifiers:{number:!0},type:"number",min:"1",step:"1",dense:"",outlined:""},null,8,["modelValue"])]),_:1}),l(p,{cols:"4"},{default:r(()=>[l(c,{label:"제품명칭",modelValue:o.productName,"onUpdate:modelValue":e[6]||(e[6]=a=>o.productName=a),readonly:"",dense:"",outlined:""},null,8,["modelValue"])]),_:1}),l(p,{cols:"8"},{default:r(()=>[l(c,{label:"지시명(계획명)",modelValue:o.orderName,"onUpdate:modelValue":e[7]||(e[7]=a=>o.orderName=a),modelModifiers:{trim:!0},dense:"",outlined:""},null,8,["modelValue"])]),_:1}),l(p,{cols:"12"},{default:r(()=>[l(Me,{label:"비고",modelValue:o.memo,"onUpdate:modelValue":e[8]||(e[8]=a=>o.memo=a),modelModifiers:{trim:!0},rows:"2","auto-grow":"",dense:"",variant:"outlined",class:"text-right"},null,8,["modelValue"])]),_:1})]),_:1}),d("div",Le,[l(w,{variant:"flat",color:"error",onClick:H},{default:r(()=>e[18]||(e[18]=[f("초기화")])),_:1}),l(w,{color:"primary",onClick:Ce},{default:r(()=>e[19]||(e[19]=[f("작업지시 등록")])),_:1})]),d("div",Oe,[d("section",Ee,[d("div",He,[e[20]||(e[20]=d("h5",{class:"pane-title"},"제품목록",-1)),d("div",Ke,[l(c,{modelValue:x.value,"onUpdate:modelValue":e[9]||(e[9]=a=>x.value=a),modelModifiers:{trim:!0},placeholder:"제품코드/명 검색","hide-details":"",density:"compact",variant:"outlined",style:{"max-width":"420px","min-width":"360px",width:"100%"},onKeyup:X(me,["enter"])},null,8,["modelValue"])])]),l(z(F),{class:"ag-theme-quartz ag-no-wrap",rowData:ue.value,columnDefs:Ve,pagination:!0,paginationPageSize:Xe,suppressPaginationPanel:!1,domLayout:"autoHeight",rowSelection:"single",onGridReady:xe,onFirstDataRendered:$,onGridSizeChanged:$,onRowSelected:Ne},null,8,["rowData"])]),d("section",je,[e[21]||(e[21]=d("div",{class:"pane-head"},[d("h5",{class:"pane-title"},"자재현황")],-1)),l(z(F),{class:"ag-theme-quartz ag-no-wrap",rowData:ce.value,columnDefs:be,pagination:!0,paginationPageSize:re,suppressPaginationPanel:!1,domLayout:"autoHeight",onGridReady:Pe,onFirstDataRendered:B,onGridSizeChanged:B},null,8,["rowData"]),e[22]||(e[22]=d("div",{class:"pane-head mt-6"},[d("h5",{class:"pane-title"},"BOM목록")],-1)),l(z(F),{class:"ag-theme-quartz ag-no-wrap bom-grid",rowData:pe.value,columnDefs:De,pagination:!0,paginationPageSize:re,suppressPaginationPanel:!1,domLayout:"autoHeight",onGridReady:We,onFirstDataRendered:U,onGridSizeChanged:U},null,8,["rowData"])])])]),_:1}),l(le,{modelValue:C.value,"onUpdate:modelValue":e[12]||(e[12]=a=>C.value=a),width:"90vw"},{default:r(()=>[l(ee,{class:"plan-card"},{default:r(()=>[l(te,{class:"d-flex align-center justify-space-between"},{default:r(()=>[e[23]||(e[23]=d("span",null,"계획서 목록",-1)),l(c,{modelValue:V.value,"onUpdate:modelValue":e[10]||(e[10]=a=>V.value=a),modelModifiers:{trim:!0},placeholder:"계획번호/제품코드/제품명 검색","hide-details":"",density:"compact",variant:"outlined",style:{width:"320px"},onKeyup:X(fe,["enter"])},null,8,["modelValue"])]),_:1}),l(ae,{class:"dialog-body"},{default:r(()=>[l(z(F),{class:"ag-theme-quartz ag-no-wrap",rowData:ve.value,columnDefs:Se,pagination:!0,paginationPageSize:et,rowSelection:"multiple",rowMultiSelectWithClick:!0,suppressRowClickSelection:!0,domLayout:"autoHeight",onGridReady:ke,onFirstDataRendered:_,onGridSizeChanged:_,onSelectionChanged:ye},null,8,["rowData"])]),_:1}),l(oe,{class:"justify-end"},{default:r(()=>[l(w,{variant:"flat",color:"darkText",onClick:e[11]||(e[11]=a=>C.value=!1)},{default:r(()=>e[24]||(e[24]=[f("닫기")])),_:1}),l(w,{variant:"flat",color:"success",onClick:we},{default:r(()=>e[25]||(e[25]=[f("등록")])),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(le,{modelValue:S.value,"onUpdate:modelValue":e[14]||(e[14]=a=>S.value=a),"max-width":"720"},{default:r(()=>[l(ee,null,{default:r(()=>[l(te,null,{default:r(()=>e[26]||(e[26]=[f("자재 부족으로 지시등록 중단")])),_:1}),l(ae,null,{default:r(()=>[e[28]||(e[28]=d("p",{class:"mb-2"},"아래 자재는 가용재고가 부족합니다. 재고 보충 후 다시 시도하세요.",-1)),l($e,{density:"compact"},{default:r(()=>[e[27]||(e[27]=d("thead",null,[d("tr",null,[d("th",null,"자재코드"),d("th",null,"자재명"),d("th",{class:"r"},"필요"),d("th",{class:"r"},"가용"),d("th",{class:"r"},"부족"),d("th",null,"단위")])],-1)),d("tbody",null,[(A(!0),q(de,null,Be(I.value,a=>(A(),q("tr",{key:a.matCode},[d("td",null,h(a.matCode),1),d("td",null,h(a.matName),1),d("td",Ze,h(a.requiredQty),1),d("td",Ye,h(a.availableQty),1),d("td",Je,h(a.shortage),1),d("td",null,h(a.unit),1)]))),128))])]),_:1})]),_:1}),l(oe,{class:"justify-end"},{default:r(()=>[l(w,{onClick:e[13]||(e[13]=a=>S.value=!1)},{default:r(()=>e[29]||(e[29]=[f("확인")])),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),l(Ue,{modelValue:N.value.open,"onUpdate:modelValue":e[15]||(e[15]=a=>N.value.open=a),color:N.value.color,timeout:2e3},{default:r(()=>[f(h(N.value.msg),1)]),_:1},8,["modelValue","color"])],64))}},nt=Ae(tt,[["__scopeId","data-v-f0cfd98d"]]);export{nt as default};
