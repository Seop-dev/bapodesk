import{aZ as le,a_ as ae,O as d,a8 as te,a7 as oe,_ as ne,P as re,q as se,o as T,a as o,w as s,c as de,k as ie,V as y,b as g,f as F,e as P,a0 as i,A as x,a1 as ue,d as me,W as fe,F as ce,$ as m}from"./index-BkOgXO0r.js";import{d as Y}from"./dayjs.min-DF61od3U.js";import{_ as pe,a as _e}from"./UiParentCard.vue_vue_type_script_setup_true_lang-BW8k9qJX.js";import{_ as ge}from"./NewModal-C5NqQFOW.js";import{B as Ce}from"./main-CfRLyuEJ.js";const ye={class:"text-right mt-2"},we={__name:"RepairManagement",setup(Ve){var b,M;le.registerModules([ae]);const I=ue,u=((M=(b=import.meta)==null?void 0:b.env)==null?void 0:M.VITE_API_BASE)||"/api",N=`${u}/process`;let C=new Map,V=new Map;const k=async()=>{const[e,l]=await Promise.all([m.get(`${u}/common/codes/FC`),m.get(`${u}/common/codes/RR`)]),t=S=>(S||[]).reduce((n,r)=>(n.set(String(r.code??r.CODE),r.code_name??r.CODE_NAME),n),new Map);C=t(e.data),V=t(l.data)},f=d(""),p=d(null),$=e=>p.value=e.api,A=e=>{p.value&&(p.value.setFilterModel({공정코드:{filterType:"text",type:"equals",filter:e||""}}),p.value.onFilterChanged())},U=d([{field:"공정코드",hide:!0,filter:"agTextColumnFilter"},{field:"설비코드",flex:1},{field:"설비명",flex:1},{field:"설비유형",flex:1},{field:"설비상태",flex:1,cellStyle:e=>e.value==="가동"?{color:"blue",fontWeight:"bold"}:e.value==="비가동"?{color:"red",fontWeight:"bold"}:null},{field:"비가동사유",flex:1},{field:"고장유형",flex:1},{field:"비가동시작시간",flex:1},{field:"담당자",flex:1}]),B={editable:!1,sortable:!0,resizable:!0},O=async()=>(await m.get(`${u}/facility`)).data||[],W=async()=>(await m.get(`${u}/facility/status`)).data||[],c=d([]),G=e=>e?Y(e).format("YYYY-MM-DD HH:mm:ss"):"-",z=(e,l)=>{const t=new Map(l.map(n=>[n.FAC_ID,n]));return e.filter(n=>Number(n.FS_STATUS)===1&&(n.FS_REASON||"")==="고장").map(n=>{const r=t.get(n.FAC_ID)||{},X=r.FAC_TYPE?C.get(String(r.FAC_TYPE))||r.FAC_TYPE:r.FAC_TYPE_NM||"-",ee=n.FS_TYPE?V.get(String(n.FS_TYPE))||n.FS_TYPE:"-";return{공정코드:r.PR_ID||"",설비코드:n.FAC_ID,설비명:n.FAC_NAME||r.FAC_NAME||"",설비유형:X,설비상태:"비가동",비가동사유:"고장",고장유형:ee,비가동시작시간:n.DOWN_STARTDAY?G(n.DOWN_STARTDAY):"-",담당자:(n.MANAGER??r.MANAGER??"").toString()||"-",_fsId:n.FS_ID}})},D=async()=>{try{await k();const[e,l]=await Promise.all([O(),W()]);c.value=z(l,e),f.value&&A(f.value)}catch(e){console.error(e),c.value=[]}},a=te({code:"",name:"",type:"",err:"",manager:"",repairStart:"",repairEnd:"",note:"",remark:"",_fsId:null}),_=d(-1),L=e=>{const l=e.data;_.value=e.rowIndex??-1,a.code=l.설비코드,a.name=l.설비명,a.type=l.설비유형,a.err=l.고장유형,a.manager=l.담당자==="-"?"":l.담당자,a.repairStart=l.비가동시작시간||E(),a.repairEnd="",a.note="",a.remark="",a._fsId=l._fsId||null};oe(()=>a.manager,e=>{_.value>-1&&c.value[_.value]&&(c.value[_.value].담당자=(e||"").trim()||"-")});const q=async()=>{var l;if(!a._fsId)return alert("선택된 비가동 건이 없습니다.");if(!((l=a.note)!=null&&l.trim()))return alert("수리내역을 입력해 주세요.");const e=a.repairEnd||E();a.repairEnd=e,await m.patch(`${u}/facility/status/end`,{FS_ID:a._fsId,endTime:e,restoreStatus:0,checkTime:e,repairContent:a.note,repairNote:a.remark||null,MANAGER:(a.manager||"").trim()||null}),a._fsId=null,await D(),a.code="",alert("수리 완료 처리되었습니다.")};function E(){const e=new Date,l=t=>String(t).padStart(2,"0");return`${e.getFullYear()}-${l(e.getMonth()+1)}-${l(e.getDate())} ${l(e.getHours())}:${l(e.getMinutes())}:${l(e.getSeconds())}`}const R=d(null),v=d(""),w=d([]),H=d([{field:"공정코드",flex:1},{field:"공정명",flex:1},{field:"설비유형",flex:1},{field:"등록일자",flex:1},{field:"작성자",flex:1},{field:"비고",flex:1}]),j=e=>({공정코드:e.PR_ID??e.PRC_CODE??"",공정명:e.PRC_NAME??"",설비유형:e.FAC_TYPE?C.get(String(e.FAC_TYPE))||e.FAC_TYPE:"-",등록일자:e.PRC_RDATE?Y(e.PRC_RDATE).format("YYYY-MM-DD"):"",작성자:e.PRC_WRITER??"",비고:e.PRC_NOTE??""}),Q=async()=>{const{data:e}=await m.get(N);return(Array.isArray(e)?e:[]).map(j)},Z=async e=>{var l;try{v.value=e,w.value=await Q(),(l=R.value)==null||l.open()}catch(t){console.error("[process list] error:",t),alert("공정 목록 조회 실패")}},h=e=>{e&&(f.value=e.공정코드||"",A(e.공정코드))};ne(D);const J=d({title:"설비 수리관리"}),K=re([{title:"설비",disabled:!0,href:"#"},{title:"수리 관리",disabled:!1,href:"#"}]);return(e,l)=>(T(),se(ce,null,[o(pe,{title:J.value.title,breadcrumbs:K.value},null,8,["title","breadcrumbs"]),o(_e,{title:"수리 관리"},{default:s(()=>[o(y,{class:"mb-2 py-0"},{default:s(()=>[o(g,{cols:"12",class:"d-flex align-center"},{default:s(()=>[o(F,{color:"warning",variant:"flat",onClick:l[0]||(l[0]=t=>Z("공정 조회"))},{default:s(()=>l[11]||(l[11]=[P("공정 조회")])),_:1})]),_:1})]),_:1}),o(y,{class:"mb-4 pt-0"},{default:s(()=>[o(g,{cols:"12",md:"3"},{default:s(()=>[o(i,{label:"공정코드",modelValue:f.value,"onUpdate:modelValue":l[1]||(l[1]=t=>f.value=t),readonly:"","hide-details":"",density:"comfortable",variant:"outlined"},null,8,["modelValue"])]),_:1})]),_:1}),o(x(Ce),{style:{height:"240px"},theme:x(I),rowData:c.value,columnDefs:U.value,defaultColDef:B,animateRows:!0,suppressClickEdit:!0,pagination:!0,"pagination-page-size":10,onGridReady:$,onRowClicked:L},null,8,["theme","rowData","columnDefs"]),o(ge,{ref_key:"modalRef",ref:R,title:v.value,rowData:w.value,colDefs:H.value,onConfirm:h},null,8,["title","rowData","colDefs"]),a.code?(T(),de(fe,{key:0,class:"mt-6 pa-4"},{default:s(()=>[o(y,{dense:""},{default:s(()=>[o(g,{cols:"12",md:"6"},{default:s(()=>[o(i,{label:"설비코드",modelValue:a.code,"onUpdate:modelValue":l[2]||(l[2]=t=>a.code=t),dense:"",outlined:"",readonly:""},null,8,["modelValue"]),o(i,{label:"설비명",modelValue:a.name,"onUpdate:modelValue":l[3]||(l[3]=t=>a.name=t),dense:"",outlined:"",readonly:""},null,8,["modelValue"]),o(i,{label:"설비유형",modelValue:a.type,"onUpdate:modelValue":l[4]||(l[4]=t=>a.type=t),dense:"",outlined:"",readonly:""},null,8,["modelValue"]),o(i,{label:"고장유형",modelValue:a.err,"onUpdate:modelValue":l[5]||(l[5]=t=>a.err=t),dense:"",outlined:"",readonly:""},null,8,["modelValue"]),o(i,{label:"수리내역",modelValue:a.note,"onUpdate:modelValue":l[6]||(l[6]=t=>a.note=t),dense:"",outlined:""},null,8,["modelValue"])]),_:1}),o(g,{cols:"12",md:"6"},{default:s(()=>[o(i,{label:"비가동 시작일",modelValue:a.repairStart,"onUpdate:modelValue":l[7]||(l[7]=t=>a.repairStart=t),dense:"",outlined:"",readonly:""},null,8,["modelValue"]),o(i,{label:"수리 완료일",modelValue:a.repairEnd,"onUpdate:modelValue":l[8]||(l[8]=t=>a.repairEnd=t),dense:"",outlined:"",readonly:""},null,8,["modelValue"]),o(i,{label:"담당자",modelValue:a.manager,"onUpdate:modelValue":l[9]||(l[9]=t=>a.manager=t),dense:"",outlined:""},null,8,["modelValue"]),o(i,{label:"비고",modelValue:a.remark,"onUpdate:modelValue":l[10]||(l[10]=t=>a.remark=t),dense:"",outlined:""},null,8,["modelValue"]),me("div",ye,[o(F,{color:"primary",onClick:q},{default:s(()=>l[12]||(l[12]=[P("수리완료")])),_:1})])]),_:1})]),_:1})]),_:1})):ie("",!0)]),_:1})],64))}};export{we as default};
