import{aa as He,O as y,y as p,aQ as V,a7 as je,_ as Je,q as k,o as g,a as s,w as o,d as n,L as ce,f as I,e as m,t as d,aR as Ye,aS as ve,V as pe,b as _,W as L,S as z,aT as W,j as $,aU as me,T as H,k as j,F as M,s as J,c as Y,a0 as C,E as Ge,aV as w,$ as Ke}from"./index-BkOgXO0r.js";import{_ as Xe,a as Ze}from"./UiParentCard.vue_vue_type_script_setup_true_lang-BW8k9qJX.js";import{_ as et}from"./_plugin-vue_export-helper-DlAUqK2U.js";const tt={class:"wizard-head"},lt={class:"steps"},at={class:"actions"},st={class:"prog-wrap"},ot={class:"prog-text"},ut={key:0,class:"picked-box"},nt={class:"picked-line truncate"},rt={key:1,class:"mt-2"},it={class:"prog-wrap"},dt={class:"prog-text"},ct={class:"mt-3"},vt={class:"grid-btns workers-scroll"},pt={class:"bold"},mt={class:"muted small"},ft={class:"mt-3"},gt={class:"grid-btns procs-grid"},_t={class:"bold"},bt={class:"muted small"},yt={class:"muted"},ht={key:0,class:"muted"},kt={class:"summary-bar"},Ct={class:"sum-left"},At={key:0},Pt={key:1,class:"muted"},wt={key:2,class:"muted"},It={class:"sum-right"},Nt={class:"bottom-row"},St={class:"keypad"},Et={class:"keypad-screen"},Rt={class:"keys"},xt=["onClick"],Ot={class:"muted small mt-1"},Tt={class:"ctrl-btns"},Vt={__name:"ProcessControl",setup(Lt){var ie,de;const fe=((de=(ie=import.meta)==null?void 0:ie.env)==null?void 0:de.VITE_API_URL)||"http://localhost:3000",A=He(),ge=y({title:"공정 진행관리"}),_e=y([{title:"생산",disabled:!0,href:"#"},{title:"공정 진행관리",disabled:!1,href:"#"}]),f=y(1),be=()=>{f.value>1&&f.value--},ye=()=>{if(f.value===1){if(!u.value)return alert("지시를 선택하세요.");if(!h.value)return alert("작업자를 선택하세요.");if(!c.value)return alert("공정을 선택하세요.");if(!v.value)return alert("설비를 선택하세요.");f.value=2}else u.value=null,h.value=null,c.value=null,v.value=null,b.value=0,P.value={startAt:"",endAt:""},f.value=1},he=p(()=>A.orders??[]),ke=p(()=>A.workers),G=y(1),u=y(null),h=y(null),c=y(null),v=y(null),S=y([]),K={"PRC-001":"CUT","PRC-002":"FAB","PRC-003":"POL","PRC-004":"PAI","PRC-005":"ASM"},Ce={CUT:"PRC-001",FAB:"PRC-002",POL:"PRC-003",PAI:"PRC-004",ASM:"PRC-005"};async function X(t=""){var r;const e=Ce[t]||"";if(!e){S.value=[];return}const l=await Ke.get(`${fe}/api/facilities`,{params:{process:e}}).catch(()=>({data:null})),a=((r=l==null?void 0:l.data)==null?void 0:r.rows)||[];S.value=a.map(i=>({id:String(i.id??i.facId??i.code),code:String(i.code??i.facId),name:i.name,process:K[i.process]||K[i.prId]||t,status:i.status||w.AVAILABLE}))}const Ae=[{title:"지시번호",value:"issueNumber",width:160},{title:"제품명",value:"productName",width:220},{title:"유형",value:"productType",width:90},{title:"상태",value:"stateCol",sortable:!1,width:110},{title:"진행률",value:"progressCol",sortable:!1,width:140,align:"end"},{title:"선택",value:"pick",sortable:!1,width:80,align:"end"}],Pe=[{title:"Id",value:"id",width:90},{title:"Name",value:"name",width:160},{title:"Status",value:"status",sortable:!1,width:100},{title:"선택",value:"pick",sortable:!1,width:80,align:"end"}],O=p(()=>v.value&&S.value.find(t=>t.id===v.value)||null),we=p(()=>S.value.filter(t=>t.process===c.value)),Z=t=>t===w.AVAILABLE?"사용가능":t===w.IN_USE?"생산중":t===w.MAINT?"점검중":t,Ie=t=>t===w.AVAILABLE?"success":t===w.IN_USE?"warning":"grey",ee=t=>t.status===w.AVAILABLE||v.value===t.id,Ne=t=>v.value===t.id?"primary":void 0;function Se(t){if(!ee(t))return alert("이 설비는 현재 선택할 수 없습니다. (상태: "+Z(t.status)+")");v.value=t.id}const Q=["CUT","FAB","POL","PAI","ASM"],q=t=>{var e;return((e=V.find(l=>l.code===t))==null?void 0:e.name)||t};function Ee(){if(!u.value)return[];const t=u.value.productType==="반제품";return Q.filter(e=>!(t&&e==="ASM"))}function D(t){const e=Ee(),l=e.indexOf(t);return l<=0?null:e[l-1]}function te(t){var a,r,i;const e=D(t);return e?((i=(r=(a=u.value)==null?void 0:a.processes)==null?void 0:r[e])==null?void 0:i.status)==="DONE":!0}function Re(t){if(!u.value){c.value=t;return}if(!te(t)){const e=D(t);alert(`이전공정을 완료해주세요. (${q(e)})`);return}c.value=t}function le(t){if(!t||!t.processes)return"N/A";const e=t.productType==="반제품",l=Q.filter(r=>!(e&&r==="ASM")),a=l.map(r=>{var i,N;return((N=(i=t.processes)==null?void 0:i[r])==null?void 0:N.status)||"IDLE"});if(a.length&&a.every(r=>r==="DONE"))return"생산완료";if(a.some(r=>r==="RUN"))return"생산중";for(let r=a.length-1;r>=0;r--)if(a[r]==="DONE")return`${q(l[r])}완료`;return"생산대기"}const xe=t=>t==="생산중"?"primary":t==="생산완료"||/완료$/.test(t)?"success":"grey",ae=t=>{const e=Object.values(t.processes||{});return e.length?Math.round(e.reduce((l,a)=>l+((a==null?void 0:a.progress)||0),0)/e.length):0};function Oe(t){u.value=t,h.value=null,c.value=null,v.value=null}const Te=p(()=>{var t,e;return(e=(t=u.value)==null?void 0:t.processes)==null?void 0:e[c.value]}),Ve=[{title:"공정",value:"name",width:90},{title:"생산량",value:"qty",align:"end",width:120},{title:"진행률",value:"progress",align:"end",sortable:!1,width:140},{title:"상태",value:"state",align:"end",sortable:!1,width:100}],Le=p(()=>{if(!u.value)return[];const t=u.value.productType==="반제품";return V.filter(e=>!(t&&e.code==="ASM"))}),E=p(()=>{var t;return((t=V.find(e=>e.code===c.value))==null?void 0:t.name)||"-"}),se=p(()=>{if(!u.value)return[];const t=u.value.productType==="반제품";return Q.filter(e=>!(t&&e==="ASM"))}),$e=(t,e)=>{var l,a;return((a=(l=t==null?void 0:t.processes)==null?void 0:l[e])==null?void 0:a.prodQty)??0},B=p(()=>{if(!u.value)return 0;const t=se.value;if(!t.length)return 0;const e=t.map(l=>$e(u.value,l));return Math.max(0,Math.min(Math.min(...e),u.value.targetQty))}),U=p(()=>u.value?Math.max(0,u.value.targetQty-B.value):0),T=p(()=>{var t,e;return((e=(t=u.value)==null?void 0:t.processes)==null?void 0:e[c.value])||null}),Me=p(()=>{var t;return((t=T.value)==null?void 0:t.prodQty)??0}),oe=p(()=>{var t;return u.value?Math.max(0,u.value.targetQty-(((t=T.value)==null?void 0:t.prodQty)??0)):0}),F=p(()=>Math.min(U.value,oe.value)),Qe=p(()=>u.value?se.value.map(e=>{const l=V.find(We=>We.code===e),a=u.value.processes[e],r=(a==null?void 0:a.prodQty)??0,i=(a==null?void 0:a.progress)??0,N=(l==null?void 0:l.name)||e;let x;return(a==null?void 0:a.status)==="RUN"?x="생산중":(a==null?void 0:a.status)==="IDLE"?x="생산대기":(a==null?void 0:a.status)==="DONE"?x=`${N}완료`:x="준비",{code:e,name:N,qty:`${r} / ${u.value.targetQty}`,progress:i,state:(a==null?void 0:a.status)||"WAIT",stateLabel:x}}):[]);function ue(t){return t==="RUN"?"primary":t==="DONE"?"success":"grey"}function qe(t){if(t==="RUN")return"생산중";if(t==="IDLE")return"생산대기";if(t==="DONE"){const e=((E==null?void 0:E.value)||"").trim();return e?`${e}완료`:"완료"}return"준비"}const b=y(0),P=y({startAt:"",endAt:""}),R=y(!1);function ne(t){const e=Number(String(b.value)+String(t));b.value=Math.min(e,F.value)}const De=()=>b.value=0,Be=()=>b.value=Math.min(b.value,F.value);function re(){const t=new Date,e=l=>String(l).padStart(2,"0");return`${t.getFullYear()}-${e(t.getMonth()+1)}-${e(t.getDate())}T${e(t.getHours())}:${e(t.getMinutes())}`}je(c,async t=>{var e,l;b.value=0,P.value={startAt:"",endAt:""},v.value=((l=(e=Te.value)==null?void 0:e.equipIds)==null?void 0:l[0])||null,await X(t||"")});async function Ue(){if(!u.value||!c.value||!h.value)return;if(!te(c.value)){const r=D(c.value);return alert(`이전공정을 완료해주세요. (${q(r)})`)}if(!v.value)return alert("설비를 선택하세요.");if(b.value<=0)return alert("투입량을 입력하세요.");const t=re();P.value.startAt=t,P.value.endAt="";const e=await A.startJob({orderId:Number(u.value.id),process:c.value,workerId:h.value.id,equipIds:[v.value],inputQty:Number(b.value)||0,startAt:t});if(!(e!=null&&e.ok))return alert((e==null?void 0:e.msg)||"작업 시작 실패");P.value.startAt=(e.startedAt||t).replace(" ","T").slice(0,16);const l=u.value.processes[c.value]??(u.value.processes[c.value]={});l.status="RUN",l.progress=Math.min(99,l.progress??0),l.equipIds=[v.value];const a=S.value.find(r=>r.id===v.value);a&&(a.status=w.IN_USE),alert("작업이 시작되었습니다.")}async function Fe(){var t;if(!R.value){R.value=!0;try{if(!u.value)return alert("지시가 선택되지 않았습니다.");if(!c.value)return alert("공정이 선택되지 않았습니다.");if(!v.value)return alert("설비가 선택되지 않았습니다.");const e=re(),l=await A.finishJob({orderId:Number(u.value.id),process:c.value,workerId:((t=h.value)==null?void 0:t.id)??null,equipIds:[v.value],startAt:P.value.startAt||null,endAt:e,inputQty:Number(b.value)||0});if(!(l!=null&&l.ok))return alert((l==null?void 0:l.msg)||"작업종료 실패");P.value.endAt=(l.endedAt||e).replace(" ","T").slice(0,16);const a=u.value.processes[c.value]??(u.value.processes[c.value]={});typeof l.prodQty=="number"&&(a.prodQty=l.prodQty),typeof l.progress=="number"&&(a.progress=l.progress),a.status=a.progress>=100?"DONE":"IDLE";const r=S.value.find(i=>i.id===v.value);if(r&&(r.status=w.AVAILABLE),await X(c.value),b.value=0,alert("작업이 종료되었습니다."),l.allDone&&alert("이 지시의 모든 공정이 완료되어 품질검사 대기 큐에 적재되었습니다."),A.loadOrders){await A.loadOrders({page:1,size:100});const i=A.orders.find(N=>Number(N.id)===Number(u.value.id));i&&(u.value=i)}}finally{R.value=!1}}}const ze=p(()=>f.value===1?!!(u.value&&h.value&&c.value&&v.value):!0);return Je(async()=>{await Promise.all([A.loadOrders({page:1,size:100}),A.loadWorkers()])}),(t,e)=>(g(),k(M,null,[s(Xe,{title:ge.value.title,breadcrumbs:_e.value},null,8,["title","breadcrumbs"]),s(Ze,{class:"pc-wrap"},{default:o(()=>[n("div",tt,[n("div",lt,[n("div",{class:ce(["step",{active:f.value===1,done:f.value>1}])},"1. 지시/작업자/공정/설비",2),e[3]||(e[3]=n("div",{class:"sep"},null,-1)),n("div",{class:ce(["step",{active:f.value===2}])},"2. 진행제어",2)]),n("div",at,[s(I,{class:"btn-sm",variant:"tonal",disabled:f.value===1,onClick:be},{default:o(()=>e[4]||(e[4]=[m("이전")])),_:1},8,["disabled"]),s(I,{class:"btn-sm",color:"primary",disabled:!ze.value,onClick:ye},{default:o(()=>[m(d(f.value<2?"다음":"초기화면"),1)]),_:1},8,["disabled"])])]),s(Ye,{modelValue:f.value,"onUpdate:modelValue":e[2]||(e[2]=l=>f.value=l),class:"mt-1"},{default:o(()=>[s(ve,{value:1},{default:o(()=>[s(pe,{dense:""},{default:o(()=>[s(_,{cols:"12"},{default:o(()=>[s(L,{variant:"outlined",class:"tight"},{default:o(()=>[s(z,{class:"tight-title"},{default:o(()=>e[5]||(e[5]=[m("지시목록")])),_:1}),s(W,{class:"no-hover table-fixed",density:"compact",headers:Ae,items:he.value,"item-key":"id","fixed-header":"",height:"300","items-per-page":5,"items-per-page-options":[5],page:G.value,"onUpdate:page":e[0]||(e[0]=l=>G.value=l)},{"item.progressCol":o(({item:l})=>[n("div",st,[s(me,{"model-value":ae(l),height:"8"},null,8,["model-value"]),n("span",ot,d(ae(l))+"%",1)])]),"item.stateCol":o(({item:l})=>[s($,{size:"small",color:xe(le(l)),variant:"tonal"},{default:o(()=>[m(d(le(l)),1)]),_:2},1032,["color"])]),"item.pick":o(({item:l})=>{var a,r;return[s(I,{class:"btn-xs",variant:((a=u.value)==null?void 0:a.id)===l.id?"elevated":"tonal",color:((r=u.value)==null?void 0:r.id)===l.id?"primary":void 0,onClick:i=>Oe(l)},{default:o(()=>{var i;return[m(d(((i=u.value)==null?void 0:i.id)===l.id?"선택됨":"선택"),1)]}),_:2},1032,["variant","color","onClick"])]}),_:1},8,["items","page"])]),_:1})]),_:1}),s(_,{cols:"12",md:"6"},{default:o(()=>[s(L,{variant:"outlined",class:"tight h-fixed"},{default:o(()=>[s(z,{class:"tight-title"},{default:o(()=>e[6]||(e[6]=[m("작업자 & 공정 선택")])),_:1}),s(H,{class:"tight-body"},{default:o(()=>[u.value?(g(),k("div",ut,[n("div",nt,[e[7]||(e[7]=n("span",{class:"muted"},"지시번호",-1)),e[8]||(e[8]=m()),n("b",null,d(u.value.issueNumber),1),e[9]||(e[9]=n("span",{class:"divider"},"|",-1)),e[10]||(e[10]=n("span",{class:"muted"},"제품",-1)),m(" "+d(u.value.productName)+" ("+d(u.value.productType)+") ",1),e[11]||(e[11]=n("span",{class:"divider"},"|",-1)),e[12]||(e[12]=n("span",{class:"muted"},"목표수량/기생산량/미생산량",-1)),n("b",null,d(u.value.targetQty),1),m(" / "+d(B.value)+" / "+d(U.value),1)])])):j("",!0),u.value?(g(),k("div",rt,[e[13]||(e[13]=n("div",{class:"label mb-1"},"공정별 생산량",-1)),s(W,{class:"no-hover no-scroll",headers:Ve,items:Qe.value,density:"compact","items-per-page":5,"items-per-page-options":[5],"hide-default-footer":""},{"item.progress":o(({item:l})=>[n("div",it,[s(me,{"model-value":l.progress,height:"6"},null,8,["model-value"]),n("span",dt,d(l.progress)+"%",1)])]),"item.state":o(({item:l})=>[s($,{size:"small",color:ue(l.state),variant:"tonal"},{default:o(()=>[m(d(l.stateLabel),1)]),_:2},1032,["color"])]),_:1},8,["items"])])):j("",!0),n("div",ct,[e[14]||(e[14]=n("div",{class:"label"},"작업자 선택",-1)),n("div",vt,[(g(!0),k(M,null,J(ke.value,l=>{var a;return g(),Y(I,{key:l.id,class:"grid-btn btn-sm",color:((a=h.value)==null?void 0:a.id)===l.id?"primary":void 0,onClick:r=>h.value=l},{default:o(()=>[n("div",pt,d(l.name),1),n("div",mt,d(l.id),1)]),_:2},1032,["color","onClick"])}),128))])]),n("div",ft,[e[15]||(e[15]=n("div",{class:"label"},"공정 선택",-1)),n("div",gt,[(g(!0),k(M,null,J(Le.value,l=>(g(),Y(I,{key:l.code,class:"grid-btn btn-sm",color:c.value===l.code?"primary":void 0,onClick:a=>Re(l.code)},{default:o(()=>[n("div",_t,d(l.name),1),n("div",bt,d(l.code),1)]),_:2},1032,["color","onClick"]))),128))])])]),_:1})]),_:1})]),_:1}),s(_,{cols:"12",md:"6"},{default:o(()=>[s(L,{variant:"outlined",class:"tight h-fixed"},{default:o(()=>[s(z,{class:"tight-title"},{default:o(()=>[e[16]||(e[16]=m(" 설비 선택 ")),n("small",yt," — "+d(E.value),1)]),_:1}),s(H,{class:"tight-body"},{default:o(()=>[c.value?(g(),Y(W,{key:1,class:"no-hover table-fixed",headers:Pe,items:we.value,density:"compact","item-key":"id","fixed-header":"",height:"240","items-per-page":5,"items-per-page-options":[5],"hide-default-footer":""},{"item.status":o(({item:l})=>[s($,{size:"small",color:Ie(l.status),variant:"tonal"},{default:o(()=>[m(d(Z(l.status)),1)]),_:2},1032,["color"])]),"item.pick":o(({item:l})=>[s(I,{class:"btn-xs",variant:v.value===l.id?"elevated":"tonal",color:Ne(l),disabled:!ee(l),onClick:a=>Se(l)},{default:o(()=>[m(d(v.value===l.id?"선택됨":"선택"),1)]),_:2},1032,["variant","color","disabled","onClick"])]),_:1},8,["items"])):(g(),k("div",ht,"공정을 먼저 선택하세요."))]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),s(ve,{value:2},{default:o(()=>{var l;return[n("div",kt,[n("div",Ct,[e[17]||(e[17]=n("span",{class:"muted"},"선택 설비",-1)),O.value?(g(),k("b",At,d(O.value.name),1)):j("",!0),O.value?(g(),k("span",Pt,"("+d(O.value.code)+")",1)):(g(),k("span",wt,"없음"))]),n("div",It,[e[18]||(e[18]=n("span",{class:"muted"},"현재 공정 상태",-1)),s($,{size:"small",color:ue((l=T.value)==null?void 0:l.status),variant:"tonal",class:"ml-2"},{default:o(()=>{var a;return[m(d(qe((a=T.value)==null?void 0:a.status)),1)]}),_:1},8,["color"])])]),s(L,{variant:"outlined",class:"tight"},{default:o(()=>[s(H,{class:"tight-body"},{default:o(()=>[s(pe,{dense:"",class:"form-grid-fixed"},{default:o(()=>[s(_,{cols:"6"},{default:o(()=>{var a;return[s(C,{label:"지시번호","model-value":(a=u.value)==null?void 0:a.issueNumber,readonly:"",variant:"outlined"},null,8,["model-value"])]}),_:1}),s(_,{cols:"6"},{default:o(()=>[s(C,{label:"공정","model-value":E.value,readonly:"",variant:"outlined"},null,8,["model-value"])]),_:1}),s(_,{cols:"6"},{default:o(()=>{var a;return[s(C,{label:"목표수량","model-value":(a=u.value)==null?void 0:a.targetQty,readonly:"",variant:"outlined"},null,8,["model-value"])]}),_:1}),s(_,{cols:"6"},{default:o(()=>[s(C,{label:"기생산량(전체)","model-value":B.value,readonly:"",variant:"outlined"},null,8,["model-value"])]),_:1}),s(_,{cols:"6"},{default:o(()=>[s(C,{label:"미생산량(전체)","model-value":U.value,readonly:"",variant:"outlined"},null,8,["model-value"])]),_:1}),s(_,{cols:"6"},{default:o(()=>{var a;return[s(C,{label:"작업자","model-value":(a=h.value)==null?void 0:a.name,readonly:"",variant:"outlined"},null,8,["model-value"])]}),_:1}),s(_,{cols:"6"},{default:o(()=>[s(C,{label:"해당 공정 생산량","model-value":Me.value,readonly:"",variant:"outlined"},null,8,["model-value"])]),_:1}),s(_,{cols:"6"},{default:o(()=>[s(C,{label:"해당 공정 미생산량","model-value":oe.value,readonly:"",variant:"outlined"},null,8,["model-value"])]),_:1}),s(_,{cols:"6"},{default:o(()=>[s(C,{label:"시작일시","model-value":P.value.startAt,readonly:"",variant:"outlined"},null,8,["model-value"])]),_:1}),s(_,{cols:"6"},{default:o(()=>[s(C,{label:"종료일시","model-value":P.value.endAt,readonly:"",variant:"outlined"},null,8,["model-value"])]),_:1})]),_:1}),n("div",Nt,[n("div",St,[n("div",Et,d(b.value),1),n("div",Rt,[(g(),k(M,null,J([1,2,3,4,5,6,7,8,9],a=>n("button",{key:a,onClick:r=>ne(a)},d(a),9,xt)),64)),n("button",{onClick:De},"C"),n("button",{onClick:e[1]||(e[1]=a=>ne(0))},"0"),n("button",{onClick:Be},"✔")]),n("div",Ot,"허용 상한: "+d(F.value),1)]),n("div",Tt,[s(I,{class:"btn-md mr-2",color:"primary",onClick:Ue},{default:o(()=>e[19]||(e[19]=[m("작업시작")])),_:1}),s(I,{class:"btn-md",color:"error",loading:R.value,disabled:R.value,onClick:Ge(Fe,["stop","prevent"])},{default:o(()=>e[20]||(e[20]=[m(" 작업종료 ")])),_:1},8,["loading","disabled"])])])]),_:1})]),_:1})]}),_:1})]),_:1},8,["modelValue"])]),_:1})],64))}},qt=et(Vt,[["__scopeId","data-v-9d50d9b0"]]);export{qt as default};
