import{aZ as G,b1 as Y,b2 as $,O as r,P as z,y as j,_ as K,b3 as L,q as H,o as J,a as l,w as o,b4 as U,V as R,f as T,e as h,A as v,a1 as Z,b as X,d as g,j as ee,t as b,b5 as te,W as ae,S as le,T as re,aM as oe,F as se,$ as E}from"./index-BkOgXO0r.js";import{_ as ie,a as de}from"./UiParentCard.vue_vue_type_script_setup_true_lang-BW8k9qJX.js";import{B as x}from"./main-CfRLyuEJ.js";import{_ as ne}from"./_plugin-vue_export-helper-DlAUqK2U.js";const ue={class:"d-flex align-center"},ce={class:"ml-auto text-caption"},fe={__name:"ProductManagementCertificate",setup(pe){G.registerModules([Y,$]);const y=Z,i=L(),P=r({title:"제품 검수관리 등록"}),V=r([{title:"품질",disabled:!0,href:"#"},{title:"제품 검수관리 등록",disabled:!1,href:"#"}]),C=r([{_id:"moisture",label:"함수율",allow:"수분 함량 12~15% (KS범위)",value:""},{_id:"dimension",label:"치수정밀도",allow:"입고자재 ±2mm 이내",value:""},{_id:"strength",label:"강도/내구성",allow:"횡강도 35MPa 이상",value:""},{_id:"stability",label:"안정성",allow:"전도 없음, 전기부 안전, 모서리 등금 위험요소 없음",value:""},{_id:"defects",label:"왼관 결점",allow:"옹이, 할렬, 긁힘 육안확인 시 결점이 없을 시",value:""},{_id:"formaldehyde",label:"포름알데히드 방출률",allow:"친환경 E0 등급(0.3mg/L)이하",value:""},{_id:"surface",label:"표면 마감/도장",allow:"도맏 들뜸 박리 없음, 균일한 색상 광택 유지",value:""}]),m=z(null),D=r({resizable:!0,minWidth:120,sortable:!1}),O=r("multiple"),A=r([{headerName:"검사명",field:"label",minWidth:160,flex:1},{headerName:"허용수치",field:"allow",minWidth:360,flex:2},{headerName:"측정값",field:"value",minWidth:360,flex:2,editable:!0},{headerName:"판정",colId:"result",minWidth:120,maxWidth:140,valueGetter:e=>{var t;return(t=e.node)!=null&&t.isSelected()?"합격":"불합격"},cellClass:e=>e.value=="합격"?"ag-cell-success":"ag-cell-error",sortable:!1},{headerName:"선택",checkboxSelection:!0,headerCheckboxSelection:!0,width:80,pinned:"right",suppressMenu:!0,sortable:!1,filter:!1}]),M=r({defaultColDef:D.value,rowSelection:"multiple",suppressRowClickSelection:!0,getRowId:e=>e.data._id}),c=r(0),f=r(0),d=j(()=>f.value===c.value?"합격":"불합격");function I(e){m.value=e.api,console.log("AG-Grid 준비 완료")}function F(e){try{e.api.selectAll(),_()}catch(t){console.error("전체 선택 오류:",t)}}function _(){const e=m.value;if(e)try{c.value=e.getDisplayedRowCount(),f.value=e.getSelectedNodes().length,e.refreshCells({columns:["result"],force:!0}),console.log(`재계산 완료: ${f.value}/${c.value}, 상태: ${d.value}`)}catch(t){console.error("재계산 오류:",t)}}const w=r([{certid:"(자동생성)",tpId:0,prdCode:"",prdName:"",prdType:"",totalQty:0,writer:"",finished_at:"",certDate:""}]),k=r([{headerName:"제품검사번호",field:"certid",width:170,editable:!1},{headerName:"제품코드",field:"prdCode",width:140,editable:!1},{headerName:"제품명",field:"prdName",width:150,editable:!1},{headerName:"제품유형",field:"prdType",width:150,editable:!1},{headerName:"총수량",field:"totalQty",width:110,editable:!1,valueParser:q},{headerName:"작업자",field:"writer",width:120,editable:!1},{headerName:"생산완료일자",field:"finished_at",width:140,editable:!1},{headerName:"검사완료일자",field:"certDate",width:140,editable:!1}]);function q(e){const t=Number(String(e.newValue).replace(/,/g,"").trim());return Number.isFinite(t)?t:e.oldValue}const Q=r({defaultColDef:{resizable:!0,minWidth:110},autoSizeStrategy:{type:"fitGridWidth"}}),p=r({description:""});function W(){try{const e=m.value;e&&(e.selectAll(),_()),p.value.description="",C.value.forEach(t=>{t.value=""}),console.log("폼이 초기화되었습니다. (전체 합격 상태)")}catch(e){console.error("초기화 오류:",e)}}async function B(){var e,t;try{const a=w.value[0],n=d.value==="합격";if(console.log("[saveForm] 시작 - 상태:",d.value,"isPass:",n),console.log("[saveForm] 선택된 항목 수:",f.value,"/",c.value),!n&&!p.value.description.trim()){alert("불합격 사유를 입력해주세요.");return}const S=m.value,N=[];if(S&&S.forEachNode(s=>{const u=s.data;N.push({stdName:u.label,allowedItem:u.allow,measuredValue:String(u.value??""),status:s.isSelected()?"합격":"불합격"})}),console.log("[saveForm] 검사 결과:",N),n){const s={TP_ID:a.tpId,PRD_CODE:a.prdCode,PRD_NAME:a.prdName,PRD_TYPE:a.prdType,TOTAL_QTY:a.totalQty,Q_CHECKED_DATE:a.certDate,CREATED_BY:a.writer};console.log("[saveForm] POST /passprd",s),(await E.post("http://localhost:3000/passprd",s)).data.ok&&alert("합격 제품이 등록되었습니다!")}else{const s={TP_ID:a.tpId,PRD_CODE:a.prdCode,PRD_NAME:a.prdName,PRD_TYPE:a.prdType,TOTAL_QTY:a.totalQty,Q_CHECKED_DATE:a.certDate,CREATED_BY:a.writer,RJT_REASON:p.value.description.trim()};console.log("[saveForm] POST /rejectprd",s);const u=await E.post("http://localhost:3000/rejectprd",s);u.data.ok&&(alert("불합격 제품이 등록되었습니다!"),console.log("등록된 인증서 ID:",u.data.prdCertId))}}catch(a){console.error("[saveForm] ERROR:",a);let n="등록 중 오류가 발생했습니다.";(t=(e=a.response)==null?void 0:e.data)!=null&&t.message?n=a.response.data.message:a.message&&(n=a.message),alert(n)}}return K(()=>{try{const e=w.value[0];e.tpId=Number(i.query.wo_no||0),e.prdCode=String(i.query.product_code||""),e.prdName=String(i.query.product_name||""),e.prdType=String(i.query.product_type||""),e.totalQty=Number(i.query.qty||0),e.writer=String(i.query.writer||""),e.finished_at=String(i.query.finished_at||""),e.certDate=new Date().toISOString().slice(0,10),console.log("초기 데이터 로드 완료:",e)}catch(e){console.error("초기 데이터 로드 오류:",e)}}),(e,t)=>(J(),H(se,null,[l(ie,{title:P.value.title,breadcrumbs:V.value},null,8,["title","breadcrumbs"]),l(de,null,{default:o(()=>[l(R,{justify:"end",class:"mb-2"},{default:o(()=>[l(T,{color:"error",class:"top_btn_ser",variant:"elevated",onClick:W},{default:o(()=>t[1]||(t[1]=[h("초기화")])),_:1}),l(T,{color:"primary",class:"top_btn_ser",onClick:B},{default:o(()=>t[2]||(t[2]=[h("등록")])),_:1})]),_:1}),l(v(x),{rowData:C.value,columnDefs:A.value,defaultColDef:D.value,rowSelection:O.value,gridOptions:M.value,theme:v(y),style:{height:"280px",width:"100%"},onGridReady:I,onFirstDataRendered:F,onSelectionChanged:_},null,8,["rowData","columnDefs","defaultColDef","rowSelection","gridOptions","theme"]),l(R,{class:"my-4"},{default:o(()=>[l(X,{cols:"12",class:"py-1"},{default:o(()=>[g("div",ue,[t[3]||(t[3]=g("h5",{class:"mr-4"},"최종처리",-1)),l(ee,{color:d.value==="합격"?"primary":"error"},{default:o(()=>[h(b(d.value),1)]),_:1},8,["color"]),g("span",ce,"선택 "+b(f.value)+"/"+b(c.value),1)])]),_:1})]),_:1}),U(l(ae,{class:"mb-4",elevation:"2"},{default:o(()=>[l(le,{class:"bg-red-lighten-5 text-red-darken-2"},{default:o(()=>t[4]||(t[4]=[h("불합격 사유")])),_:1}),l(re,null,{default:o(()=>[l(oe,{modelValue:p.value.description,"onUpdate:modelValue":t[0]||(t[0]=a=>p.value.description=a),label:"불합격 사유",variant:"outlined",rows:"3",counter:"500",maxlength:"500",rules:[a=>d.value==="합격"||a&&a.length>0||"불합격 시 사유는 필수입니다."]},null,8,["modelValue","rules"])]),_:1})]),_:1},512),[[te,d.value==="불합격"]]),l(v(x),{rowData:w.value,columnDefs:k.value,gridOptions:Q.value,theme:v(y),style:{height:"160px",width:"100%"}},null,8,["rowData","columnDefs","gridOptions","theme"])]),_:1})],64))}},we=ne(fe,[["__scopeId","data-v-b74014d4"]]);export{we as default};
